<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <title>Smart Librarian</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container py-5">
    <h2 class="mb-4 text-center fw-bold">Smart Librarian ‚Äì AI Book Recommendations</h2>

    <form method="POST" class="mb-4">
        <div class="input-group">
            <input type="text" name="query" placeholder="Write your prompt..." class="form-control" required>
            <button type="submit" class="btn btn-primary">Send</button>
        </div>
    </form>

    {% if result %}
        <div class="card mb-4 shadow-sm">
            <div class="card-body">
                <h5 class="card-title">üìñ AI Answer:</h5>
                <p class="card-text" id="ai-result">{{ result|safe }}</p>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-success" onclick="speakText()">üîä Play</button>
                    <button type="button" class="btn btn-secondary" onclick="stopSpeech()">‚èπ Stop</button>
                    <button type="button" class="btn btn-info" onclick="generateImage()">üé® Generate Image</button>
                </div>
            </div>
        </div>

        <div id="image-container" class="text-center"></div>
    {% endif %}
</div>

<script>
    let currentAudio = null;

    function speakText() {
        const summary = document.getElementById("ai-result").innerText;

        fetch("/speak", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                summary: summary,
                model: "tts-1",
                voice: "nova"
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.audio_url) {
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                }
                currentAudio = new Audio(data.audio_url);
                currentAudio.play();
            } else {
                alert("Eroare la redarea vocii: " + (data.error || "necunoscutƒÉ"));
            }
        });
    }

    function stopSpeech() {
        if (currentAudio) {
            currentAudio.pause();
            currentAudio.currentTime = 0;
        }
    }

    function generateImage() {
        const resultText = document.getElementById("ai-result").innerText;
        const prompt = "Create a book cover based on the following text: " + resultText;

        // Show spinner before fetch
        document.getElementById("image-container").innerHTML = `
            <div class="text-center mt-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Generating image...</p>
            </div>
        `;

        fetch("/generate_image", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt: prompt })
        })
        .then(response => response.json())
        .then(data => {
            if (data.image_url) {
                // Replace spinner with the image
                document.getElementById("image-container").innerHTML = `
                    <h4 class="mt-4">Generated Book Image</h4>
                    <img src="${data.image_url}" alt="Book cover" class="img-fluid rounded shadow-sm mt-3" style="max-width: 400px;">
                `;
            } else {
                alert("‚ö†Ô∏è Eroare la generarea imaginii: " + (data.error || "necunoscutƒÉ"));
            }
        });
    }

</script>
</body>
</html>
