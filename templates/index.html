<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <title>Smart Librarian</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container py-5">
    <h2 class="mb-4 text-center fw-bold">Smart Librarian â€“ AI Book Recommendations</h2>

    <form method="POST" class="mb-4">
        <div class="input-group">
            <input type="text" id="query-input" name="query" placeholder="Write your prompt..." class="form-control" required>
            <button type="submit" class="btn btn-primary">Send</button>
            <button type="button" class="btn btn-outline-secondary" id="start-recording-btn">ğŸ™ï¸ Speak</button>

        </div>
    </form>

    {% if result %}
        <div class="card mb-4 shadow-sm">
            <div class="card-body">
                <h5 class="card-title">ğŸ“– AI Answer:</h5>
                <p class="card-text" id="ai-result">{{ result|safe }}</p>

                <div class="d-flex flex-wrap gap-2 mt-3">
                    <button type="button" class="btn btn-success" onclick="speakText()">ğŸ”Š Play</button>
                    <button type="button" class="btn btn-secondary" onclick="stopSpeech()">â¹ Stop</button>

                    {% if recommended_titles and recommended_titles|length == 1 %}
                        <button type="button" class="btn btn-info" onclick="generateImage()">ğŸ¨ Generate Image</button>
                    {% else %}
                        <button type="button" class="btn btn-info" disabled>ğŸ¨ Generate Image (1 book required)</button>
                    {% endif %}
                </div>
            </div>
        </div>

        <div id="image-container" class="text-center"></div>
    {% endif %}
</div>

<!-- JS Section -->
<script>
    let currentAudio = null;
    let recommendedTitle = {{ (recommended_titles[0] if recommended_titles and recommended_titles|length == 1 else "null") | tojson }};
    let mediaRecorder;
    let audioChunks = [];

    const queryInput = document.getElementById("query-input");
    const startRecordingBtn = document.getElementById("start-recording-btn");
    const recordingStatus = document.createElement("small");
    recordingStatus.className = "text-muted ms-2";
    startRecordingBtn.after(recordingStatus);

    startRecordingBtn.addEventListener("click", async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

            mediaRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const formData = new FormData();
                formData.append("audio", audioBlob, "input.webm");

                recordingStatus.textContent = "ğŸ•“ Transcribing...";

                fetch("/voice_transcribe", {
                    method: "POST",
                    body: formData
                })
                .then(res => res.json())
                .then(data => {
                    if (data.transcription) {
                        queryInput.value = data.transcription;
                        recordingStatus.textContent = "âœ… Transcription done. Submitting...";
                        setTimeout(() => {
                            document.querySelector("form").submit(); // Submit after inserting
                        }, 1000);
                    } else {
                        recordingStatus.textContent = "âŒ Could not transcribe.";
                    }
                });
            };

            mediaRecorder.start();
            recordingStatus.textContent = "ğŸ™ï¸ Listening... Click again to stop.";
            startRecordingBtn.textContent = "ğŸ›‘ Stop";

            // Replace the click handler to stop next time
            startRecordingBtn.onclick = () => {
                mediaRecorder.stop();
                stream.getTracks().forEach(track => track.stop());
                startRecordingBtn.textContent = "ğŸ™ï¸ Speak";
                startRecordingBtn.onclick = null; // Reset to original listener
            };
        } catch (err) {
            console.error("Mic access error:", err);
            recordingStatus.textContent = "âŒ Microphone access denied.";
        }
    });

    function speakText() {
        const summary = document.getElementById("ai-result").innerText;

        fetch("/speak", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                summary: summary,
                model: "tts-1",
                voice: "nova"
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.audio_url) {
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                }
                currentAudio = new Audio(data.audio_url);
                currentAudio.play();
            } else {
                alert("Eroare la redarea vocii: " + (data.error || "necunoscutÄƒ"));
            }
        });
    }

    function stopSpeech() {
        if (currentAudio) {
            currentAudio.pause();
            currentAudio.currentTime = 0;
        }
    }

    function generateImage() {
        if (!recommendedTitle) {
            alert("Image generation is only available when exactly one book is recommended.");
            return;
        }

        const prompt = `Create a book cover for the book titled: ${recommendedTitle}`;

        document.getElementById("image-container").innerHTML = `
            <div class="text-center mt-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Generating image...</p>
            </div>
        `;

        fetch("/generate_image", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt: prompt })
        })
        .then(response => response.json())
        .then(data => {
            if (data.image_url) {
                document.getElementById("image-container").innerHTML = `
                    <h4 class="mt-4">Generated Book Image</h4>
                    <img src="${data.image_url}" alt="Book cover" class="img-fluid rounded shadow-sm mt-3" style="max-width: 400px;">
                `;
            } else {
                alert("âš ï¸ Eroare la generarea imaginii: " + (data.error || "necunoscutÄƒ"));
            }
        });
    }
    
</script>
</body>
</html>
