<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <title>Smart Librarian</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(to bottom right, #f0f4f8, #d9e4f5);
            min-height: 100vh;
            font-family: "Segoe UI", Roboto, sans-serif;
        }

        .app-container {
            max-width: 750px;
            background-color: #ffffff;
            border-radius: 16px;
            padding: 3rem 2rem;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }

        .app-title {
            font-weight: 700;
            font-size: 2rem;
            color: #2c3e50;
        }

        .input-group > input {
            border-top-left-radius: 8px;
            border-bottom-left-radius: 8px;
        }

        .input-group > button {
            border-top-right-radius: 8px;
            border-bottom-right-radius: 8px;
        }

        .btn {
            height: 100%;
            padding: 0.6rem 1rem;
        }

        .card-title {
            font-weight: 600;
            font-size: 1.2rem;
            color: #34495e;
        }

        .card-text {
            font-size: 1.05rem;
            color: #333;
        }

        #image-container img {
            transition: transform 0.3s ease;
        }

        #image-container img:hover {
            transform: scale(1.03);
        }
    </style>
</head>
<body>

<div class="container py-5 d-flex justify-content-center">
    <div class="app-container w-100">
        <h2 class="app-title text-center mb-4">Smart Librarian â€“ AI Book Recommendations</h2>

        <form method="POST" class="mb-4">
            <div class="input-group">
                <input type="text" id="query-input" name="query" placeholder="Ask for book suggestions, summaries..." class="form-control shadow-sm" required>
                <button type="submit" class="btn btn-primary">Send</button>
                <button type="button" class="btn btn-outline-secondary" id="start-recording-btn">ğŸ™ï¸</button>
            </div>
        </form>

        {% if result %}
            <div class="card mb-4 shadow-sm border-0">
                <div class="card-body">
                    <h5 class="card-title">AI Answer</h5>
                    <p class="card-text" id="ai-result">{{ result|safe }}</p>

                    <div class="d-flex flex-wrap gap-2 mt-3">
                        <button type="button" class="btn btn-success" id="play-btn">ğŸ”Š Play</button>
                        <button type="button" class="btn btn-secondary" id="stop-btn">â¹ Stop</button>

                        {% if recommended_titles and recommended_titles|length == 1 %}
                            <button type="button" class="btn btn-info" id="generate-image-btn">ğŸ¨ Generate Image</button>
                        {% else %}
                            <button type="button" class="btn btn-info" disabled>ğŸ¨ Generate Image (1 book required)</button>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div id="image-container" class="text-center mt-4"></div>
        {% endif %}
    </div>
</div>

<!-- Inject Flask data as JSON -->
<script id="data-script" type="application/json">
    {
        "recommendedTitle": {{ (recommended_titles[0] if recommended_titles and recommended_titles|length == 1 else "null") | tojson }}
    }
</script>

<!-- Your JavaScript logic remains unchanged -->
<script>
    let currentAudio = null;
    let mediaRecorder;
    let audioChunks = [];

    const data = JSON.parse(document.getElementById("data-script").textContent);
    let recommendedTitle = data.recommendedTitle;

    const queryInput = document.getElementById("query-input");
    const startRecordingBtn = document.getElementById("start-recording-btn");
    const recordingStatus = document.createElement("small");
    recordingStatus.className = "text-muted ms-2";
    startRecordingBtn.after(recordingStatus);

    startRecordingBtn.addEventListener("click", async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

            mediaRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const formData = new FormData();
                formData.append("audio", audioBlob, "input.webm");

                recordingStatus.textContent = "ğŸ•“ Transcribing...";

                fetch("/voice_transcribe", {
                    method: "POST",
                    body: formData
                })
                .then(res => res.json())
                .then(data => {
                    if (data.transcription) {
                        queryInput.value = data.transcription;
                        recordingStatus.textContent = "âœ… Transcription done. Submitting...";
                        setTimeout(() => {
                            document.querySelector("form").submit();
                        }, 1000);
                    } else {
                        recordingStatus.textContent = "âŒ Could not transcribe.";
                    }
                });
            };

            mediaRecorder.start();
            recordingStatus.textContent = "ğŸ™ï¸ Listening... Click again to stop.";
            startRecordingBtn.textContent = "ğŸ›‘ Stop";

            startRecordingBtn.onclick = () => {
                mediaRecorder.stop();
                stream.getTracks().forEach(track => track.stop());
                startRecordingBtn.textContent = "ğŸ™ï¸ Speak";
                startRecordingBtn.onclick = null;
            };
        } catch (err) {
            console.error("Mic access error:", err);
            recordingStatus.textContent = "âŒ Microphone access denied.";
        }
    });

    document.getElementById("play-btn")?.addEventListener("click", () => {
        const summary = document.getElementById("ai-result")?.innerText;
        if (!summary) return;

        fetch("/speak", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                summary: summary,
                model: "tts-1",
                voice: "nova"
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.audio_url) {
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                }
                currentAudio = new Audio(data.audio_url);
                currentAudio.play();
            } else {
                alert("Eroare la redarea vocii: " + (data.error || "necunoscutÄƒ"));
            }
        });
    });

    document.getElementById("stop-btn")?.addEventListener("click", () => {
        if (currentAudio) {
            currentAudio.pause();
            currentAudio.currentTime = 0;
        }
    });

    document.getElementById("generate-image-btn")?.addEventListener("click", () => {
        if (!recommendedTitle) {
            alert("Image generation is only available when exactly one book is recommended.");
            return;
        }

        const prompt = `Create a book cover for the book titled: ${recommendedTitle}`;

        document.getElementById("image-container").innerHTML = `
            <div class="text-center mt-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Generating image...</p>
            </div>
        `;

        fetch("/generate_image", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt: prompt })
        })
        .then(response => response.json())
        .then(data => {
        if (data.image_base64) {
    document.getElementById("image-container").innerHTML = `
        <h4 class="mt-4">Generated Book Image</h4>
        <img src="data:image/png;base64,${data.image_base64}" 
             alt="Book cover" 
             class="img-fluid rounded shadow-sm mt-3" 
             style="max-width: 400px;">
            `;
        }
    
         else {
                alert("âš ï¸ Eroare la generarea imaginii: " + (data.error || "necunoscutÄƒ"));
            }
        });
    });
</script>
</body>
</html>
